<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>참여 페이지</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
  <style>
    body {
      margin-left: 150px;
      margin-right: 150px;
    }

    aside {
      width: 100%;
      height: 100%;
      clear: both;
    }

    section {
      float: left;
      width: 93%;
    }

    textarea {
      border: 2px solid rgb(213, 194, 194);
      outline-color: coral;
    }

    div.nameMargin {
      margin-bottom: 20px;
    }

    hr {
      border-top: 1px;
      border-style: dotted;
      /*width: 50%;*/
    }
  </style>
  <script name="viewLoaded" th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
      const form = [[${form}]];

      let title = document.getElementById("title");
      title.innerText = form.title;
      let description = document.getElementById("description");
      description.innerText = form.description;

      let questionList = [[${questions}]];
      for (let i = 0; i < questionList.length; i++) {
        console.log(questionList[i]);
        let question = questionList[i];
        if (question.type === "TEXT") {
            addTextDiv(question, i);
        } else if (question.type === "CHECKBOX") {
          addCheckBoxDiv(question, i);
        }
      }
    })

    function addTextDiv(question, i) {
      let newDiv = document.createElement("div");
      let title = question.title;

      newDiv.innerHTML = "    <article id=\"formContent" + i + "\" style=\"padding-bottom: 10px; padding-top: 10px\">\n" +
              "      <div class=\"card\" style=\"padding: 30px\">\n" +
              "        <div class=\"card-body\">\n" +
              "          <div class=\"row\" id=\"parent" + i + "\">\n" +
              "            <div class=\"col-8\" class=\"nameMargin\">\n" +
              "              <p class=\"fs-5\" id=\"question" + i + "\">" + title + "</p>\n" +
              "            </div>\n" +
              "            <div class=\"childDiv\">\n" +
              "              <textarea class=\"form-control\" id=\"answer" + i + "\" aria-label=\"With textarea\" placeholder=\"내 답변\"></textarea>\n" +
              "            </div>\n" +
              "          </div>\n" +
              "        </div>\n" +
              "      </div>\n" +
              "    </article>";

      let section = document.getElementById('section');
      section.appendChild(newDiv);
    }

    function addCheckBoxDiv(question, i) {
      let checkboxListHtml = '';
      for (let j = 0; j < question.checkboxList.length; j++) {
        const contentString = question.checkboxList[j];
        checkboxListHtml += "         <div class=\"input-group mb-3\" class=\"col-8\" id=\"addCheckBoxDiv" + j + "\" style=\"width: 50%;\">\n" +
                "             <label>"+
                "             <div class=\"input-group-text\">\n" +
                "                 <input class=\"form-check-input mt-0\" type=\"radio\" name=\"check" + i + "\" value=\"" + contentString + "\" aria-label=\"Checkbox for following text input\">\n" +
                "             </div>\n" +
                "             <input type=\"text\" class=\"form-control\" aria-label=\"Text input with checkbox\" readonly value=\"" + contentString + "\">\n" +
                "             </label>"+
                "         </div>\n";
      }
      let newDiv = document.createElement("div");
      newDiv.innerHTML = "    <article id=\"formContent" + i + "\" style=\"padding-bottom: 10px; padding-top: 10px\">\n" +
              "      <div class=\"card\" style=\"padding: 30px\">\n" +
              "        <div class=\"card-body\">\n" +
              "          <div class=\"row\" id=\"parent" + i + "\">\n" +
              "            <div class=\"col-8\" id=\"nameMargin\">\n" +
              "              <p class=\"fs-5\" id=\"question" + i + "\">질문 제목</p>\n" +
              "            </div>\n" +
              "            <div class=\"childDiv\" id=\"childDiv" + i + "\">\n" +
              checkboxListHtml +
              "            </div>\n" +
              "          </div>\n" +
              "        </div>\n" +
              "      </div>\n" +
              "    </article>";

      let section = document.getElementById('section');
      section.appendChild(newDiv);
    }

    // document.addEventListener('DOMContentLoaded', () => {
    //   const checkboxs = document.querySelectorAll('[name=check]');
    //
    //   checkboxs.forEach((checkbox) => {
    //     checkbox.addEventListener('change', (event) => {
    //       const current = event.currentTarget
    //       if (current.checked) {
    //
    //       }
    //     })
    //   })
    // })
  </script>
</head>
<body>
  <section>
    <div class="card" style="margin-top: 10px; margin-bottom: 10px">
      <h5 class="card-header">선착순 Form</h5>
      <div class="card-body" style="padding: 30px">
        <p class="fs-2" id="title"></p>
        <br>
        <hr>
        <p class="fs-5" id="description"></p>
      </div>
    </div>
  </section>
  <section id="section">
  </section>

  <section style="padding-bottom: 10px; padding-top: 10px">
    <button id="postAnswerButton" type="button" class="btn btn-warning">제출</button>
  </section>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
  <script name="api" th:inline="javascript" src="createAnswerApi.js">
    const form = [[${form}]];
    let host = "http://localhost:8080/api/v1/"

    const postAnswerButton = document.querySelector("#postAnswerButton");
    let orderCount;
    postAnswerButton.addEventListener("click", () => {
      fetch(host + "answer/" + form.id, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          postAnswerListRequest: createAnswers()
        })
      })
            .then((response) => response.json())
            .then((data) => {
              orderCount = data.count;
            })
            .catch(err => {
              console.log('Fetch Error', err);
            });
    //TODO: 실시간 서버 응답 받기 구현
      const sse = new EventSource(host + "answer/" + form.id + "/order/" + orderCount);
      sse.addEventListener('connet', function (event) {
        console.log(event.data);

        const data = JSON.parse(event.data);
        const order = data.content;
        console.log(order);
      })
    })

    function createAnswers() {
      let questionList = [[${questions}]];
      const questionCnt = questionList.length;

      let answerList = [];
      for (let i = 0; i <= questionCnt; i++) {
        let questionDivList = document.getElementById("formContent" + i);
        let childDivList = document.getElementsByClassName("childDiv");

        if (questionList[i].type === "TEXT") {
          const answerText = document.getElementById('answer' + i);
          answerList.push(answerText);
        } else if (questionList[i].type === "CHECKBOX") {
          const checkboxVaule = document.querySelector('input[name=check' + i + ']:checked').value;
          answerList.push(checkboxVaule);
        }

      }
      return answerList;
    }
  </script>
</body>
</html>